!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.ImmyBox={})}(this,function(e){"use strict";function t(e,t){return!!e.className.match(new RegExp("(\\s|^)"+t+"(\\s|$)"))}function i(e,i){t(e,i)||(e.className+=" "+i)}function n(e,i){if(t(e,i)){var n=new RegExp("(\\s|^)"+i+"(\\s|$)");e.className=e.className.replace(n," ")}}function s(e,t){return e.parentNode&&e.parentNode.matches?e.parentNode.matches(t)?e.parentNode:s(e.parentNode,t):null}function r(e,t){return e.matches&&e.matches(t)?e:s(e,t)}function l(e,t,i,n){n.has(i)||n.set(i,new Map),n.get(i).set(e,t),i.addEventListener(e,t)}function o(e){var t=new Map;return c.set(e,t),t}var u={};u["typeof"]=function(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},u.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},u.createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),u.slicedToArray=function(){function e(e,t){var i=[],n=!0,s=!1,r=void 0;try{for(var l,o=e[Symbol.iterator]();!(n=(l=o.next()).done)&&(i.push(l.value),!t||i.length!==t);n=!0);}catch(u){s=!0,r=u}finally{try{!n&&o["return"]&&o["return"]()}finally{if(s)throw r}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),u.toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)},Number.isNaN=Number.isNaN||function(e){return"number"==typeof e&&isNaN(e)},Array.prototype.find||(Array.prototype.find=function(e){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,i=Object(this),n=i.length>>>0,s=arguments[1],r=0;n>r;r++)if(t=i[r],e.call(s,t,r,i))return t}),Array.prototype.includes||(Array.prototype.includes=function(e){var t=Object(this),i=parseInt(t.length)||0;if(0===i)return!1;var n,s=parseInt(arguments[1])||0;s>=0?n=s:(n=i+s,0>n&&(n=0));for(var r;i>n;){if(r=t[n],e===r||e!==e&&r!==r)return!0;n++}return!1});var c=new Map,a={choices:[],maxResults:50,showArrow:!0,openOnClick:!0,defaultSelectedValue:void 0,scroll_behavior:"smooth",filterFn:function(e){var t=e.toLowerCase();return function(e){return e.text.toLowerCase().indexOf(t)>=0}},formatChoice:function(e){if(!e)return function(e){return e.text};var t=function(){var t=new RegExp(e.replace(/[#-.]|[[-^]|[?|{}]/g,"\\$&"),"gi");return{v:function(e){return e.text.replace(t,'<span class="highlight">$&</span>')}}}();return"object"===("undefined"==typeof t?"undefined":u["typeof"](t))?t.v:void 0}},h=new Map,d="immybox",f=function(){function e(t,s){var c=this;u.classCallCheck(this,e),i(t,d),t.setAttribute("autocomplete","off");var a=o(this);this.element=t,this.options=Object.assign({},e.defaults,s),this.choices=this.options.choices,null!=this.options.defaultSelectedValue&&(this.choices=[this.choices.find(function(e){var t=e.value;return t===c.options.defaultSelectedValue})].concat(u.toConsumableArray(this.choices.filter(function(e){var t=e.value;return t!==c.options.defaultSelectedValue}))).filter(function(e){return e})),this.indexed_choices=this.choices.map(function(e,t){return{index:t,choice:e}}),this.values=this.choices.map(function(e){return e.value}),this.selectedChoice=null,this.options.showArrow&&i(this.element,d+"_witharrow"),this.selectChoiceByValue(this.element.value),this.queryResultArea=document.createElement("div"),i(this.queryResultArea,d+"_results"),this.queryResultAreaVisible=!1,this._val=this.element.value,this.oldQuery=this.element.value,this.options.openOnClick&&l("click",this.openResults.bind(this),this.element,a),l("click",function(e){var t=r(e.target,"li."+d+"_choice");if(t){var i=c.valueFromElement(t);c.selectChoiceByValue(i),c.hideResults(),c._val=c.element.value,c.element.focus()}},this.queryResultArea,a),l("mouseenter",function(e){var t=r(e.target,"li."+d+"_choice");t&&(i(t,"active"),[].concat(u.toConsumableArray(c.queryResultArea.querySelectorAll("li."+d+"_choice.active"))).forEach(function(e){return e!==t&&n(e,"active")}))},this.queryResultArea,a),l("keyup",this.doQuery.bind(this),this.element,a),l("change",this.doQuery.bind(this),this.element,a),l("search",this.doQuery.bind(this),this.element,a),l("keydown",this.doSelection.bind(this),this.element,a),h.set(this.element,this)}return u.createClass(e,[{key:"doQuery",value:function(){var e=this.element.value;this._val!==e&&(this._val=e,this.oldQuery=e,e?this.insertFilteredChoiceElements(e):(this.hideResults(),this.selectChoiceByValue(null)))}},{key:"doSelection",value:function(e){if(27===e.which&&(this.display(),this.hideResults()),this.queryResultAreaVisible)switch(e.which){case 9:this.selectHighlightedChoice();break;case 13:e.preventDefault(),this.selectHighlightedChoice();break;case 38:e.preventDefault(),this.highlightPreviousChoice(),this.scroll();break;case 40:e.preventDefault(),this.highlightNextChoice(),this.scroll()}else switch(e.which){case 40:e.preventDefault(),this.selectedChoice?this.insertFilteredChoiceElements(this.oldQuery):this.insertFilteredChoiceElements("");break;case 9:this.revert()}}},{key:"openResults",value:function(e){e.cancelBubble=!0,e.stopPropogation&&e.stopPropogation(),this.revertOtherInstances(),this.selectedChoice?this.insertFilteredChoiceElements(this.oldQuery):this.insertFilteredChoiceElements("")}},{key:"revert",value:function(){this.queryResultAreaVisible?(this.display(),this.hideResults()):""===this.element.value&&this.selectChoiceByValue(null)}},{key:"reposition",value:function(){this.queryResultAreaVisible&&this.positionResultsArea()}},{key:"insertFilteredChoiceElements",value:function(e){var t=this,n=void 0;""===e?n=this.indexed_choices:!function(){var i=t.options.filterFn(e);n=t.indexed_choices.filter(function(e,t){var n=e.choice;return i(n,t)})}();var s=n.slice(0,this.options.maxResults);this.defaultSelectedChoice&&n.indexOf(this.defaultSelectedChoice)>=0&&(-1===s.indexOf(this.defaultSelectedChoice)?(s.unshift(this.defaultSelectedChoice),s.pop()):(s=s.filter(function(e){return e.choice.value!==t.defaultSelectedChoice.value}),s.unshift(this.defaultSelectedChoice)));var r=this.options.formatChoice(e),l=!1,o=document.createElement("ul"),u=s.map(function(e){var n=e.choice,s=e.index,u=document.createElement("li");return u.setAttribute("class",d+"_choice"),u.setAttribute("data-immybox-value-index",s),u.innerHTML=r(n),t.selectedChoice&&s===t.selectedChoice.index&&(l=!0,i(u,"active")),o.appendChild(u),u});for(u.length?this.valueFromElement(u[0])===this.options.defaultSelectedValue&&!l&&i(u[0],"active"):(o=document.createElement("p"),o.setAttribute("class",d+"_noresults"),o.textContent="no matches");this.queryResultArea.lastChild;)this.queryResultArea.removeChild(this.queryResultArea.lastChild);this.queryResultArea.appendChild(o),this.showResults()}},{key:"scroll",value:function(){this.highlightedChoice&&this.highlightedChoice.scrollIntoView({behavior:this.options.scroll_behavior})}},{key:"positionResultsArea",value:function(){var e=this.element.getBoundingClientRect(),t=this.element.clientHeight,i=this.element.clientWidth,n=this.queryResultArea.clientHeight,s=e.top+t+n,r=window.clientHeight+window.scrollTop;this.queryResultArea.style.width=i+"px",this.queryResultArea.style.left=e.left+"px",s>r?this.queryResultArea.style.top=e.top-n+"px":this.queryResultArea.style.top=e.top+t+"px"}},{key:"highlightNextChoice",value:function(){var e=this.highlightedChoice;if(e){var t=e.nextSibling;t&&(n(e,"active"),i(t,"active"))}else{var s=this.queryResultArea.querySelector("li."+d+"_choice");s&&i(s,"active")}}},{key:"highlightPreviousChoice",value:function(){var e=this.highlightedChoice;if(e){var t=e.previousSibling;t&&(n(e,"active"),i(t,"active"))}else{var s=this.queryResultArea.querySelector("li."+d+"_choice:last-child");s&&i(s,"active")}}},{key:"selectHighlightedChoice",value:function(){var e=this.highlightedChoice;e?(this.selectChoiceByValue(this.valueFromElement(e)),this.hideResults()):this.revert()}},{key:"display",value:function(){this.element.value=this.selectedChoice&&this.selectedChoice.choice.text||"","undefined"!=typeof Event&&this.element.dispatchEvent(new Event("input")),this._val=this.element.value}},{key:"selectChoiceByValue",value:function(e){var t=this.value;this.selectedChoice=e&&this.indexed_choices.find(function(t){var i=t.choice;return i.value==e})||null;var i=this.value;i!==t&&this.element.dispatchEvent(new CustomEvent("update",{detail:i})),this.display()}},{key:"revertOtherInstances",value:function(){var e=this;h.forEach(function(t){return t!==e&&t.revert()})}},{key:"valueFromElement",value:function(e){var t=parseInt(e.getAttribute("data-immybox-value-index"));return Number.isNaN(t)?void 0:this.values[t]}},{key:"showResults",value:function(){console.log("showing results",this.queryResultAreaVisible),!this.queryResultAreaVisible&&document.body.appendChild(this.queryResultArea),this.queryResultAreaVisible=!0,this.scroll(),this.positionResultsArea()}},{key:"hideResults",value:function(){this.queryResultAreaVisible&&document.body.removeChild(this.queryResultArea),this.queryResultAreaVisible=!1}},{key:"getChoices",value:function(){return this.choices}},{key:"setChoices",value:function(e){var t=this;return this.choices=e,null!=this.options.defaultSelectedValue&&(this.choices=[this.choices.find(function(e){var i=e.value;return i===t.options.defaultSelectedValue})].concat(u.toConsumableArray(this.choices.filter(function(e){var i=e.value;return i!==t.options.defaultSelectedValue}))).filter(function(e){return e})),this.indexed_choices=this.choices.map(function(e,t){return{choice:e,index:t}}),this.selectedChoice&&this.selectChoiceByValue(this.selectedChoice.choice.value),this.oldQuery="",this.choices}},{key:"getValue",value:function(){return this.value}},{key:"setValue",value:function(e){this.value=e}},{key:"destroy",value:function(){var e=!0,t=!1,i=void 0;try{for(var s,r=c.get(this)[Symbol.iterator]();!(e=(s=r.next()).done);e=!0){var l=u.slicedToArray(s.value,2),o=l[0],a=l[1],f=!0,v=!1,y=void 0;try{for(var p,m=a[Symbol.iterator]();!(f=(p=m.next()).done);f=!0){var C=u.slicedToArray(p.value,2),g=C[0],b=C[1];o.removeEventListener(g,b)}}catch(A){v=!0,y=A}finally{try{!f&&m["return"]&&m["return"]()}finally{if(v)throw y}}}}catch(A){t=!0,i=A}finally{try{!e&&r["return"]&&r["return"]()}finally{if(t)throw i}}n(this.element,d),this.queryResultAreaVisible&&document.body.removeChild(this.queryResultArea),h["delete"](this.element)}},{key:"highlightedChoice",get:function(){var e=this.queryResultArea.querySelector("li."+d+"_choice.active");return e||null}},{key:"value",get:function(){return this.selectedChoice&&this.selectedChoice.choice.value||null},set:function(e){return this.value!==e&&(this.selectChoiceByValue(e),this.oldQuery=""),this.value}}],[{key:"pluginForElement",value:function(e){return h.get(e)}},{key:"repositionAll",value:function(){window.requestAnimationFrame(function(){h.forEach(function(e){e.queryResultAreaVisible&&e.reposition()})})}},{key:"revertAll",value:function(){h.forEach(function(e){return e.revert()})}},{key:"repositionWhenScrolling",value:function(t){t.addEventListener("scroll",e.repositionAll)}},{key:"defaults",set:function(e){Object.assign(a,e)},get:function(){return a}},{key:"pluginMethods",get:function(){return["showResults","hideResults","getChoices","setChoices","getValue","setValue","destroy"]}}]),e}();document.addEventListener("DOMContentLoaded",function(){document.body.addEventListener("click",f.revertAll),window.addEventListener("resize",f.repositionAll)}),window.ImmyBox=f,e.all_objects=h,e.plugin_name=d,e.ImmyBox=f});